PO SYSTEM - FIX & DEBUG GUIDE
==============================

ISSUE ANALYSIS
==============
The new PO system had format mismatches with your existing project:
1. ✗ Was using JSON input instead of POST variables
2. ✗ Layout not integrated with existing header/sidebar
3. ✗ No debugging options for troubleshooting
4. ✗ Different input handling than other forms (add-product.php, etc)

SOLUTION APPLIED
================

✓ FIXED: createPurchaseOrder.php
  - Now uses $_POST variables (matches project pattern)
  - Added debug array to track issues
  - Same error handling as createProduct.php
  - Proper transaction handling (BEGIN/COMMIT/ROLLBACK)
  - Returns JSON but processes POST

✓ FIXED: create_po.php
  - Now posts directly to php_action/createPurchaseOrder.php
  - Integrated with existing layout (head, header, sidebar)
  - Uses standard Bootstrap classes from your project
  - Matches styling of add-product.php, add-brand.php

✓ ADDED: Debugging Options
  - DEBUG_MODE in createPurchaseOrder.php
  - Error logging to file (logs/po_creation_errors.log)
  - Debug array in response
  - Display errors in JSON response

✓ ADDED: po_diagnostic.php (TEST FILE)
  - Complete system diagnostic
  - Check all tables, files, permissions
  - Show what's working and what's broken
  - Quick fixes suggestions


HOW TO TEST & DEBUG
===================

STEP 1: Run Diagnostic
---------------------
1. Go to: http://localhost/Satyam_Clinical/po_diagnostic.php
2. Check for any errors marked with ❌
3. Follow suggestions to fix (usually missing tables or suppliers)

STEP 2: Test PO Creation
-----------------------
1. Make sure at least 1 supplier exists (go to supplier.php or view_po.php)
2. Make sure products exist (go to product.php)
3. Go to: http://localhost/Satyam_Clinical/create_po.php
4. Fill form and submit
5. Check for error messages

STEP 3: Debug Failed Creation
-----------------------------
If PO creation fails:

OPTION A: Check Response JSON
  - Open browser DevTools (F12)
  - Go to Network tab
  - Submit form
  - Look for createPurchaseOrder.php request
  - Click it and see Response tab
  - Look for "debug" array with error details

OPTION B: Check Error Log
  - File: logs/po_creation_errors.log
  - Open with text editor
  - See PHP errors with line numbers

OPTION C: Check Browser Console
  - Open DevTools (F12)
  - Go to Console tab
  - Submit form and watch for JavaScript errors

STEP 4: Common Problems & Solutions
-----------------------------------

PROBLEM: "No POST data received"
SOLUTION: 
  - Ensure form method="POST" action="php_action/createPurchaseOrder.php"
  - Check browser Network tab to see if form data is being sent
  - Clear browser cache (Ctrl+Shift+Delete)

PROBLEM: "Please select a valid Supplier"
SOLUTION:
  - supplier_id is 0 or missing
  - Go to po_list.php and check if suppliers exist
  - If not, create supplier first
  - Make sure supplier_id is being posted correctly

PROBLEM: "Transaction error" or SQL errors
SOLUTION:
  - Run diagnostic: po_diagnostic.php
  - Check if purchase_order table exists
  - Run migration: mysql < dbFile/migration_po_schema.sql
  - Check table columns match what PHP code expects

PROBLEM: Form not submitting (JavaScript error)
SOLUTION:
  - Check DevTools Console (F12) for JS errors
  - Make sure you're not using JSON.stringify (we use POST)
  - Look at create_po.php form - ensure all input names are correct

PROBLEM: "User session expired"
SOLUTION:
  - User must be logged in first
  - Go to login.php and login
  - Then try creating PO again
  - Session ID: check if $_SESSION['userId'] is set


DEBUGGING CHECKLIST
===================

For each error you encounter, check:

FORM SUBMISSION
[ ] Method is POST not GET
[ ] Action points to php_action/createPurchaseOrder.php
[ ] Form has name="po_number", name="supplier_id", etc
[ ] All required fields have values
[ ] JavaScript isn't preventing form submit

DATABASE
[ ] purchase_order table exists
[ ] purchase_order_items table exists
[ ] suppliers table has data
[ ] medicine_details/product table has data
[ ] Columns match what PHP expects (use po_diagnostic.php to check)

SESSION
[ ] User is logged in
[ ] $_SESSION['userId'] is set
[ ] Session hasn't expired

INPUT DATA
[ ] po_number has a value
[ ] supplier_id is numeric and > 0
[ ] All numeric fields (subtotal, tax, etc) are numbers
[ ] Dates are in correct format (Y-m-d)
[ ] No special characters in strings causing SQL issues

OUTPUT RESPONSE
[ ] Check JSON response for "debug" array
[ ] Look for SQL errors in debug array
[ ] Check binding parameter types match actual data
[ ] Verify column names in INSERT statement match table


ENABLING FULL DEBUG OUTPUT
===========================

To see full debugging info:

1. EDIT: php_action/createPurchaseOrder.php
   Find: define('DEBUG_MODE', true);
   Keep it true for debugging
   Change to false in production

2. Check logs at: logs/po_creation_errors.log
   (Create logs folder if not exists)

3. Look at JSON response for "debug" key
   Each request logs:
   - PO data received
   - Validation steps
   - SQL queries
   - Transaction status
   - Item processing
   - Errors with exact messages


TESTING WITH SAMPLE DATA
=========================

Before testing PO creation:

1. Login to system (get userId)

2. Create test supplier (in supplier.php or through po_list.php):
   - Name: Test Supplier Inc
   - Contact: 9999999999
   - Email: test@supplier.com
   - GST: 27AAPCU1234A1Z0
   - Address: Test Address

3. Verify products exist (product.php)
   - Should have medicines/products with prices

4. Then test PO creation:
   - PO Number: Auto-generated (read-only)
   - PO Date: Today's date
   - Select Test Supplier
   - Add line items with quantities and prices
   - Click Create
   - Check if success message appears

5. Verify PO created:
   - Go to po_list.php
   - Should see your new PO
   - Click on it to see details


FILES THAT WERE FIXED
====================

1. php_action/createPurchaseOrder.php
   - Rewrote to use $_POST instead of json_decode
   - Added proper debugging
   - Same pattern as createProduct.php
   - Transaction-based for data integrity

2. create_po.php
   - Updated form action to php_action/createPurchaseOrder.php
   - Added message div for responses
   - Uses existing layout (head, header, sidebar)
   - All input names match what backend expects

3. po_diagnostic.php (ALREADY EXISTS)
   - Shows current system status
   - Lists all checks and results
   - Suggests fixes for failures


FILES YOU STILL NEED TO FIX
===========================

1. po_list.php
   - Check form field names match createPO form
   - Ensure cancel button only shows for right statuses

2. print_po.php
   - Verify it reads from correct table columns
   - Check if all data is displaying correctly

3. cancel_po.php
   - Update to use POST variables
   - Add proper debugging like createPurchaseOrder.php

4. cancelPO.php (backend)
   - Update to use $_POST instead of JSON
   - Add debugging


NEXT STEPS FOR YOU
=================

1. IMMEDIATE (5 minutes):
   [ ] Go to po_diagnostic.php
   [ ] Note any ❌ ERRORS
   [ ] Note any ⚠️ WARNINGS
   [ ] Fix if possible (usually add suppliers/products)

2. TEST (10 minutes):
   [ ] Go to create_po.php
   [ ] Fill in a simple PO
   [ ] Submit and check for success
   [ ] Go to po_list.php to verify PO was created

3. DEBUG IF NEEDED (varies):
   [ ] If error, check po_diagnostic.php again
   [ ] Look at JSON response (Network tab in DevTools)
   [ ] Check debug array for exact error
   [ ] Fix issue and retry

4. FIX REMAINING FILES (30 minutes):
   [ ] Update cancel_po.php for POST variables
   [ ] Update cancelPO.php backend
   [ ] Test cancellation workflow
   [ ] Verify print_po.php works


SUPPORT & REFERENCE
===================

Debug file paths:
- Errors: logs/po_creation_errors.log
- Diagnostic: po_diagnostic.php
- Test responses: Check DevTools Network tab

Key files:
- Form: create_po.php
- Backend: php_action/createPurchaseOrder.php
- List view: po_list.php
- Print: print_po.php
- Cancellation: cancel_po.php + php_action/cancelPO.php

Reference implementations (match these patterns):
- add-product.php / php_action/createProduct.php
- add-brand.php / php_action/createBrand.php
- add-category.php / php_action/createCategories.php

Database:
- Tables: purchase_order, purchase_order_items, suppliers, medicine_details
- Column info: See po_diagnostic.php
- Schema: dbFile/migration_po_schema.sql


DEBUGGING JAVASCRIPT (IF FORM NOT SUBMITTING)
==============================================

Open DevTools (F12) and paste in Console:

// Check if form element exists
console.log('Form exists:', document.getElementById('poForm'));

// Check form data when submitting
document.getElementById('poForm').addEventListener('submit', function(e) {
  console.log('Form data:', new FormData(this));
  console.log('POST keys:', Array.from(new FormData(this).keys()));
});

// Check if values are being populated
console.log('PO Number:', document.getElementById('poNumber').value);
console.log('Supplier ID:', document.getElementById('supplierId').value);


COMMON PHP ERRORS TO LOOK FOR
=============================

In po_creation_errors.log or DevTools Response:

✓ Means fixed or working
✗ Means still needs attention

✓ "No POST data received" - Fixed
✓ "User session expired" - Fixed
✓ "Please select valid Supplier" - Fixed
✗ "Table doesn't exist" - Run migration
✗ "Column X doesn't exist" - Run migration
✗ "Duplicate entry for key" - Check database state
✗ "Foreign key constraint" - Check supplier/product IDs


GETTING HELP
============

If still having issues:

1. Screenshot po_diagnostic.php output
2. Screenshot error from DevTools or console
3. Check po_creation_errors.log for PHP errors
4. Note exact error message
5. Check if table/column exists using po_diagnostic.php
6. Verify sample data (suppliers, products) exist


END OF DEBUG GUIDE
==================

You now have:
✓ Fixed createPurchaseOrder.php to use POST
✓ Fixed create_po.php form layout  
✓ Debugging options enabled
✓ Diagnostic tool (po_diagnostic.php) ready
✓ This complete guide

Next: Go to po_diagnostic.php and check system status!
